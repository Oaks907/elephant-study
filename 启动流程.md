

## 流程

1、开机第一站：BIOS

  BIOS是ROM（Read Only Memory），此ROM被映射到低端1MB内存的顶部，即地址0xF0000 ~ 0xFFFFF,只要访问该处地址，就相当于访问了BIOS，这个映射由硬件完成

* 通电瞬间，CPU的CS：IP寄存器被强制初始化为 0xF000:0xFFF0，对应内存地址为 0xFFFF0。

* BIOS程序，会进行检测内存、显卡等外设信息，当检测通过，并初始化硬件好后，开始在内存0x000 ~ 0x3FF外建立数据结构中断向量表并填写中断例程。
BIOS 最后一项工作是校验启动盘中位于 0 盘 0 道 1 扇区的内容，如果此扇区末尾两个字节为0x55和0xaa,BIOS便认为此扇区存在可执行程序，便加载到地址0x7c00。此时完成了BIOS到MBR程序的交接，既完成了硬件固定程序到软件的交接。


2、第二站：BIOS完成后跳转到该位置 0x7c00 MBR内存中的位置

代码中的MBR代码会被nasm编译为 mbr.bin, 然后手动写入到hd60M中 0盘0道1扇区 起始地址为 0x7C00，算是写入了硬件磁盘扇道。MBR的作用如下：

* 加载内核加载器 Loader，并将接力帮给 Loader 程序
  

3、第三站：实现内核加载器

* 进入保护模式，加载GDT全局描述符表
* 加载内核：将内核文件加载到内存缓冲区
  * 读取扇区文件数据到内存中
  * 开启分页
* 初始化内核：需要在分页后，将加载进来的elf内核文件安置到相应的虚拟内存地址，然后跳过去执行，然后loader工作结束

    初始化内核就是根据ELF规范将内核文件的段（segment）展开（复制）到内存中的相应位置。内核映像地址选取的物理地址是 0x1500，对应虚拟地址为 0xC0001500

## Loader内存说明 （基于C4 a 章节代码）

代码
```c
   %include "boot.inc"
   section loader vstart=LOADER_BASE_ADDR
   LOADER_STACK_TOP equ LOADER_BASE_ADDR
   jmp loader_start					; 此处的物理地址是: jmp .+535                 ; e91702 跳转地址 0xb1a
   
;构建gdt及其内部的描述符
   GDT_BASE:   dd    0x00000000 
	       dd    0x00000000

   CODE_DESC:  dd    0x0000FFFF 
	       dd    DESC_CODE_HIGH4

   DATA_STACK_DESC:  dd    0x0000FFFF
		     dd    DESC_DATA_HIGH4

   VIDEO_DESC: dd    0x80000007	       ;limit=(0xbffff-0xb8000)/4k=0x7
	       dd    DESC_VIDEO_HIGH4  ; 此时dpl已改为0

   GDT_SIZE   equ   $ - GDT_BASE
   GDT_LIMIT   equ   GDT_SIZE -	1 
   times 60 dq 0					 ; 此处预留60个描述符的slot
   SELECTOR_CODE equ (0x0001<<3) + TI_GDT + RPL0         ; 相当于(CODE_DESC - GDT_BASE)/8 + TI_GDT + RPL0
   SELECTOR_DATA equ (0x0002<<3) + TI_GDT + RPL0	 ; 同上
   SELECTOR_VIDEO equ (0x0003<<3) + TI_GDT + RPL0	 ; 同上 

   ;以下是定义gdt的指针，前2字节是gdt界限，后4字节是gdt起始地址

   gdt_ptr  dw  GDT_LIMIT 
	    dd  GDT_BASE
   loadermsg db '2 loader in real.'

   loader_start:

;------------------------------------------------------------
;INT 0x10    功能号:0x13    功能描述:打印字符串
;------------------------------------------------------------
;输入:
;AH 子功能号=13H
;BH = 页码
;BL = 属性(若AL=00H或01H)
;CX＝字符串长度
;(DH、DL)＝坐标(行、列)
;ES:BP＝字符串地址 
;AL＝显示输出方式
;   0——字符串中只含显示字符，其显示属性在BL中。显示后，光标位置不变
;   1——字符串中只含显示字符，其显示属性在BL中。显示后，光标位置改变
;   2——字符串中含显示字符和显示属性。显示后，光标位置不变
;   3——字符串中含显示字符和显示属性。显示后，光标位置改变
;无返回值
   mov	 sp, LOADER_BASE_ADDR
   mov	 bp, loadermsg           ; ES:BP = 字符串地址
   mov	 cx, 17			 ; CX = 字符串长度
   mov	 ax, 0x1301		 ; AH = 13,  AL = 01h
   mov	 bx, 0x001f		 ; 页号为0(BH = 0) 蓝底粉红字(BL = 1fh)
   mov	 dx, 0x1800		 ;
   int	 0x10                    ; 10h 号中断

;----------------------------------------   准备进入保护模式   ------------------------------------------
									;1 打开A20
									;2 加载gdt
									;3 将cr0的pe位置1


   ;-----------------  打开A20  ----------------
   in al,0x92
   or al,0000_0010B
   out 0x92,al

   ;-----------------  加载GDT  ----------------
   lgdt [gdt_ptr]


   ;-----------------  cr0第0位置1  ----------------
   mov eax, cr0
   or eax, 0x00000001
   mov cr0, eax

   ;jmp dword SELECTOR_CODE:p_mode_start	     ; 刷新流水线，避免分支预测的影响,这种cpu优化策略，最怕jmp跳转，
   jmp  SELECTOR_CODE:p_mode_start	     ; 刷新流水线，避免分支预测的影响,这种cpu优化策略，最怕jmp跳转，
					     ; 这将导致之前做的预测失效，从而起到了刷新的作用。

[bits 32]
p_mode_start:
   mov ax, SELECTOR_DATA
   mov ds, ax
   mov es, ax
   mov ss, ax
   mov esp,LOADER_STACK_TOP
   mov ax, SELECTOR_VIDEO
   mov gs, ax

   mov byte [gs:160], 'P'

   jmp $
```

内存地址数据：
```c
<bochs:8> x /2000wx 0x900
[bochs]:
0x00000900 <bogus+       0>:	0x000217e9	0x00000000	0xff000000	0x000000ff
0x00000910 <bogus+      16>:	0xff00cf98	0x000000ff	0x0700cf92	0x0b800000
0x00000920 <bogus+      32>:	0x0000c092	0x00000000	0x00000000	0x00000000
0x00000930 <bogus+      48>:	0x00000000	0x00000000	0x00000000	0x00000000
0x00000940 <bogus+      64>:	0x00000000	0x00000000	0x00000000	0x00000000
0x00000950 <bogus+      80>:	0x00000000	0x00000000	0x00000000	0x00000000
0x00000960 <bogus+      96>:	0x00000000	0x00000000	0x00000000	0x00000000
0x00000970 <bogus+     112>:	0x00000000	0x00000000	0x00000000	0x00000000
0x00000980 <bogus+     128>:	0x00000000	0x00000000	0x00000000	0x00000000
0x00000990 <bogus+     144>:	0x00000000	0x00000000	0x00000000	0x00000000
0x000009a0 <bogus+     160>:	0x00000000	0x00000000	0x00000000	0x00000000
0x000009b0 <bogus+     176>:	0x00000000	0x00000000	0x00000000	0x00000000
0x000009c0 <bogus+     192>:	0x00000000	0x00000000	0x00000000	0x00000000
0x000009d0 <bogus+     208>:	0x00000000	0x00000000	0x00000000	0x00000000
0x000009e0 <bogus+     224>:	0x00000000	0x00000000	0x00000000	0x00000000
0x000009f0 <bogus+     240>:	0x00000000	0x00000000	0x00000000	0x00000000
0x00000a00 <bogus+     256>:	0x00000000	0x00000000	0x00000000	0x00000000
0x00000a10 <bogus+     272>:	0x00000000	0x00000000	0x00000000	0x00000000
0x00000a20 <bogus+     288>:	0x00000000	0x00000000	0x00000000	0x00000000
0x00000a30 <bogus+     304>:	0x00000000	0x00000000	0x00000000	0x00000000
0x00000a40 <bogus+     320>:	0x00000000	0x00000000	0x00000000	0x00000000
0x00000a50 <bogus+     336>:	0x00000000	0x00000000	0x00000000	0x00000000
0x00000a60 <bogus+     352>:	0x00000000	0x00000000	0x00000000	0x00000000
0x00000a70 <bogus+     368>:	0x00000000	0x00000000	0x00000000	0x00000000
0x00000a80 <bogus+     384>:	0x00000000	0x00000000	0x00000000	0x00000000
0x00000a90 <bogus+     400>:	0x00000000	0x00000000	0x00000000	0x00000000
0x00000aa0 <bogus+     416>:	0x00000000	0x00000000	0x00000000	0x00000000
0x00000ab0 <bogus+     432>:	0x00000000	0x00000000	0x00000000	0x00000000
0x00000ac0 <bogus+     448>:	0x00000000	0x00000000	0x00000000	0x00000000
0x00000ad0 <bogus+     464>:	0x00000000	0x00000000	0x00000000	0x00000000
0x00000ae0 <bogus+     480>:	0x00000000	0x00000000	0x00000000	0x00000000
0x00000af0 <bogus+     496>:	0x00000000	0x00000000	0x00000000	0x00000000
0x00000b00 <bogus+     512>:	0x1f000000	0x00090300	0x6c203200	0x6564616f
0x00000b10 <bogus+     528>:	0x6e692072	0x61657220	0x00bc2e6c	0x0b09bd09
0x00000b20 <bogus+     544>:	0xb80011b9	0x1fbb1301	0x1800ba00	0x92e410cd
0x00000b30 <bogus+     560>:	0x92e6020c	0x0316010f	0xc0200f0b	0x01c88366
0x00000b40 <bogus+     576>:	0xeac0220f	0x00080b48	0x0010b866	0xc08ed88e
0x00000b50 <bogus+     592>:	0x00bcd08e	0x66000009	0x8e0018b8	0x05c665e8
0x00000b60 <bogus+     608>:	0x000000a0	0x00feeb50	0x00000000	0x00000000
0x00000b70 <bogus+     624>:	0x00000000	0x00000000	0x00000000	0x00000000
0x00000b80 <bogus+     640>:	0x00000000	0x00000000	0x00000000	0x00000000
0x00000b90 <bogus+     656>:	0x00000000	0x00000000	0x00000000	0x00000000
0x00000ba0 <bogus+     672>:	0x00000000	0x00000000	0x00000000	0x00000000
0x00000bb0 <bogus+     688>:	0x00000000	0x00000000	0x00000000	0x00000000
0x00000bc0 <bogus+     704>:	0x00000000	0x00000000	0x00000000	0x00000000
0x00000bd0 <bogus+     720>:	0x00000000	0x00000000	0x00000000	0x00000000
0x00000be0 <bogus+     736>:	0x00000000	0x00000000	0x00000000	0x00000000
0x00000bf0 <bogus+     752>:	0x00000000	0x00000000	0x00000000	0x00000000
0x00000c00 <bogus+     768>:	0x66db3166	0x4d4150ba	0x0b0abf53	0xe820b866
0x00000c10 <bogus+     784>:	0xb9660000	0x00000014	0x327215cd	0x06ffcf01
0x00000c20 <bogus+     800>:	0x83660bfe	0xe47500fb	0x0bfe0e8b	0x0b0abb66
0x00000c30 <bogus+     816>:	0x31660000	0x8b6766d2	0x03676603	0x83660843
0x00000c40 <bogus+     832>:	0x396614c3	0x66037dc2	0xe9e2c289	0x01b858eb
0x00000c50 <bogus+     848>:	0x7215cde8	0x0400b932	0xc166e1f7	0x256610e2
0x00000c60 <bogus+     864>:	0x0000ffff	0x66c20966	0x0000c281	0x89660010
0x00000c70 <bogus+     880>:	0xc03166d6	0xb966d889	0x00010000	0x66e1f766
0x00000c80 <bogus+     896>:	0x8966c601	0xb41febf2	0x7215cd88	0xff25663b
0x00000c90 <bogus+     912>:	0xb90000ff	0xe1f70400	0x10e2c166	0x66c20966
0x00000ca0 <bogus+     928>:	0x0000c281	0x89660010	0xe40b0016	0xe6020c92
0x00000cb0 <bogus+     944>:	0x16010f92	0x200f0b04	0xc88366c0	0xc0220f01
0x00000cc0 <bogus+     960>:	0x0cc9ea66	0x00080000	0x10b866f4	0x8ed88e00
0x00000cd0 <bogus+     976>:	0xbcd08ec0	0x00000900	0x0018b866	0x09b8e88e
0x00000ce0 <bogus+     992>:	0xbb000000	0x00070000	0x0000c8b9	0x0129e800
0x00000cf0 <bogus+    1008>:	0xaae80000	0x0f000000	0x0b040501	0x1d8b0000
0x00000d00 <bogus+    1024>:	0x00000b06	0x001c4b81	0x81c00000	0x000b0605
0x00000d10 <bogus+    1040>:	0x00000000	0x00c481c0	0xb8c00000	0x00100000
0x00000d20 <bogus+    1056>:	0x0fd8220f	0x000dc020	0x0f800000	0x010fc022
0x00000d30 <bogus+    1072>:	0x000b0415	0x0d3cea00	0x00080000	0x00000ae8
0x00000d40 <bogus+    1088>:	0xf000bc00	0xb5e9c009	0x31c00007	0x31db31c0
0x00000d50 <bogus+    1104>:	0x66d231c9	0x002a158b	0x1d8b0007	0x0007001c
0x00000d60 <bogus+    1120>:	0x0000c381	0x8b660007	0x07002c0d	0x003b8000
0x00000d70 <bogus+    1136>:	0x73ff1774	0x04438b10	0x07000005	0x73ff5000
0x00000d80 <bogus+    1152>:	0x0008e808	0xc4830000	0xe2d3010c	0x55fcc3e0
0x00000d90 <bogus+    1168>:	0x8b51e589	0x758b087d	0x104d8b0c	0x5d59a4f3
0x00000da0 <bogus+    1184>:	0x1000b9c3	0x00be0000	0xc6000000	0x10000086
0x00000db0 <bogus+    1200>:	0xe2460000	0x0000b8f6	0x00050010	0x89000010
0x00000dc0 <bogus+    1216>:	0x07c883c3	0x100000a3	0x0c00a300	0x002d0010
0x00000dd0 <bogus+    1232>:	0xa3000010	0x00100ffc	0x000100b9	0x0000be00
0x00000de0 <bogus+    1248>:	0x07ba0000	0x89000000	0xc281b314	0x00001000
0x00000df0 <bogus+    1264>:	0xb8f4e246	0x00100000	0x00200005	0x07c88300
0x00000e00 <bogus+    1280>:	0x100000bb	0x00feb900	0x01be0000	0x89000003
0x00000e10 <bogus+    1296>:	0x0546b304	0x00001000	0x89c3f5e2	0xcf8966c6
0x00000e20 <bogus+    1312>:	0x01f2ba66	0x89eec888	0xf3ba66f0	0x08b1ee01
0x00000e30 <bogus+    1328>:	0xba66e8d3	0xd3ee01f4	0xf5ba66e8	0xe8d3ee01
0x00000e40 <bogus+    1344>:	0xe00c0f24	0x01f6ba66	0xf7ba66ee	0xee20b001
0x00000e50 <bogus+    1360>:	0x8824ec90	0xf875083c	0x66f88966	0x660100ba
0x00000e60 <bogus+    1376>:	0x8966e2f7	0xf0ba66c1	0x66ed6601	0xc3830389
0x00000e70 <bogus+    1392>:	0xc3f6e202	0x00000000	0x00000000	0x00000000
0x00000e80 <bogus+    1408>:	0x00000000	0x00000000	0x00000000	0x00000000
0x00000e90 <bogus+    1424>:	0x00000000	0x00000000	0x00000000	0x00000000
0x00000ea0 <bogus+    1440>:	0x00000000	0x00000000	0x00000000	0x00000000
0x00000eb0 <bogus+    1456>:	0x00000000	0x00000000	0x00000000	0x00000000
0x00000ec0 <bogus+    1472>:	0x00000000	0x00000000	0x00000000	0x00000000
0x00000ed0 <bogus+    1488>:	0x00000000	0x00000000	0x00000000	0x00000000
```
Loader的起始地址为 0x00000900 ，存储的内容为 jmp loader_start ,即：e91702

0x000217e9	0x00000000	0xff000000 根据小端表示法表示为 e9170200 00000000 000000ff

* 0x000217e9	--> e9170200
* 0x00000000	--> 00000000
* 0xff000000    --> 000000ff

反编译数据
```shell

```

